<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                <div class="card">
                    <div class="header" style="border-bottom: 1px solid #00000021;">
                        <div class="row">
                            <h2 class="col-xl-3 col-lg-3 col-md-3 col-sm-3 pb-0 pt-2 bolder">Localités</h2>
                            <h2 class="col-xl-1 col-lg-2 col-md-2 col-sm-2 pb-0 pt-2 pr-0" [hidden]="entreprises && entreprises.length<=1">Entités :</h2>
                            <div class="col-xl-3 col-lg-3 col-md-5 col-sm-5 pb-0" [hidden]="entreprises && entreprises.length<=1">
                                <select [(ngModel)]="idCurrentEse" class="form-control select-trie" (change)="entiteChange($event.target.value)">
                                    <option *ngFor="let e of entreprises" [value]="e.id">{{e.denomination}}</option>
                                </select>
                            </div>
                            <ul class="header-dropdown m-r--5">
                                <li class="dropdown">
                                    <button class="addInv" data-toggle="modal" data-target="#localiteModal" data-backdrop="static" data-keyboard="false"
                                    (click)="initForm()" mat-mini-fab title="Ajouter un inventaire" color="primary" aria-label="Example icon-button with a heart icon">
                                        <mat-icon>add</mat-icon>
                                    </button>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="body">
                        <div class="map-localite mb-5" [ngStyle]="{background: 'url(./assets/images/image-gallery/font-maps.jpg)'}">
                            <div class="pointer-localite pointer" *ngFor="let localite of rev(localites)" [ngStyle]="{'left': localite.position[0],'top':localite.position[1],'width':'10%'}">
                                <span (click)="idCurrentLocal=localite.id" class="pl-1">{{longText(localite.nom,11)}}</span>
                                <img src="assets/images/image-gallery/pointer.png" [title]="localite.nom" style="width:50%;" *ngIf="idCurrentLocal!=localite.id"  (click)="idCurrentLocal=localite.id">
                                <img src="assets/images/image-gallery/pointer2.png" [title]="localite.nom" style="width:50%;" *ngIf="idCurrentLocal==localite.id">
                            </div>
                        </div>
                        <mat-accordion>
                            <mat-expansion-panel class="mb-4" *ngFor="let localite of rev(localites)" [expanded]="idCurrentLocal === localite.id"  hideToggle [hidden]="idCurrentLocal != localite.id">
                                <mat-expansion-panel-header  class="pr-0" style="background-color: #d8d5d5;" (click)="pickLocalite(localite)"  #panelHL (click)="panelHL._toggle()">
                                    <mat-panel-title class="pl-0 col-11 pt-4 pb-4 mr-0" (click)="panelHL._toggle()">
                                        {{localite.nom}}
                                    </mat-panel-title>
                                    <mat-panel-description> 
                                        <i></i>
                                        <div class="pt-4 pb-4">
                                            <mat-icon data-toggle="modal" class="mr-2 icone-loc" data-target="#localiteModal" data-backdrop="static" data-keyboard="false"  (click)="updateLoc(localite)">edit</mat-icon>
                                            <mat-icon *ngIf="localite.zones.length==0" class="icone-loc" (click)="deleteLoc(localite)">delete</mat-icon>
                                            <mat-icon *ngIf="localite.zones.length>0" class="icone-loc" title="Impossible de supprimer une localité contenant des zones" (click)="noteRemovable('localité')">delete</mat-icon>
                                        </div>
                                    </mat-panel-description>
                                </mat-expansion-panel-header>
                                    <p class="mt-4 mb-3 bolder">Zones / Sites</p>
                                    <mat-expansion-panel class="mb-4" *ngFor="let zone of rev(localite.zones)"  [expanded]="idCurrentZ === zone.id" hideToggle>
                                        <mat-expansion-panel-header  class="pr-0" style="background-color: #eab9b9;"  #panelHZ (click)="panelHZ._toggle()">
                                            <mat-panel-title class="pl-0 col-11 pt-4 pb-4 mr-0" (click)="panelHZ._toggle()">
                                                {{zone.nom}}
                                            </mat-panel-title>
                                            <mat-panel-description><i></i> 
                                                <div  class="pt-4 pb-4">
                                                    <mat-icon class="icone-loc" data-toggle="modal" data-target="#zoneModal" #ezone data-backdrop="static" data-keyboard="false" (click)="updateZone(zone)">edit</mat-icon>
                                                    <mat-icon *ngIf="getSousZone(zone).length==0" class="icone-loc" (click)="deleteZone(zone)">delete</mat-icon>
                                                    <mat-icon *ngIf="getSousZone(zone).length>0" class="icone-loc" title="Impossible de supprimer une zone contenant des sous-zones" (click)="noteRemovable('zone')">delete</mat-icon>
                                                </div>
                                            </mat-panel-description>
                                        </mat-expansion-panel-header>
                                        
                                        <div class="row">
                                        
                                            <div class="col-lg-12 col-md-12 col-sm-12 col-12">
                                                <div class="card">
                                                    <div class="body">
                                                        <mat-form-field class="example-chip-list example-full-width">
                                                            <mat-chip-list #chipList aria-label="Sous-zones">
                                                                <mat-chip *ngFor="let sousZone of getSousZone(zone)" [selectable]="selectable" [removable]="removable"
                                                                    (removed)="remove(zone,sousZone)">
                                                                    {{sousZone}}
                                                                    <mat-icon *ngIf="removable" class="ml-2 edit-sousZ pointer text-secondary" (click)="updateSousZones(zone,sousZone)"  (click)="openSZModal.click()">edit</mat-icon>
                                                                    <!---->
                                                                    <mat-icon matChipRemove *ngIf="removable" class="ml-0">delete</mat-icon>
                                                                    
                                                                </mat-chip>
                                                                <input placeholder="Sous-zone" #fruitInput [formControl]="fruitCtrl"
                                                                    [matChipInputFor]="chipList"
                                                                    [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
                                                                    (matChipInputTokenEnd)="add($event,zone)">
                                                            </mat-chip-list>
                                                        </mat-form-field>
                                                        <!--Pour editer sous-zone -->
                                                        <i data-toggle="modal" hidden data-target="#SousZoneModal" data-backdrop="static" data-keyboard="false" #openSZModal></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                    </mat-expansion-panel>
                                    <p class="mt-4"><i class="material-icons pointer" title="Ajouter zone/site" data-toggle="modal" data-target="#zoneModal" data-backdrop="static" data-keyboard="false" (click)="pickLocalite(localite)" (click)="initForm2()">add_circle</i></p>
                            </mat-expansion-panel>
                        </mat-accordion>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>


<!--Localités-->
<div class="modal fade" id="localiteModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" data-keyboard="false">
    <div class="modal-dialog" role="document">
        <form class="modal-content"  [formGroup]="localiteForm" (ngSubmit)="addLocalite(localiteForm)" #formDirective1="ngForm">
            <div class="modal-header">
                <div class="editRowModal">
                    <div class="modal-header clearfix">
                        <div class="modal-about">
                            <div class="font-weight-bold p-t-10 font-17" *ngIf="localiteForm.get('id').value==0">Ajouter une localité</div>
                            <div class="font-weight-bold p-t-10 font-17" *ngIf="localiteForm.get('id').value!=0">Modifier une localité</div>
                        </div>
                    </div>
                </div>
                <button type="button" #closeLocaliteModal
                    class="btn p-t-10 modal-close-button" data-dismiss="modal"
                    aria-label="Close">
                    <i class="material-icons">clear</i>
                </button>
            </div>
            <div class="modal-body">
                <div>
                    <div class="row">
                        <div class="input-field col s12 d-none">
                            <input formControlName="id" class="form-control" type="hidden">
                        </div>
                        <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 pb-0">
                            <mat-form-field class="example-full-width" appearance="outline">
                                <mat-label>Nom de la localité</mat-label>
                                <input matInput formControlName="nom" >
                                <mat-icon matSuffix>room</mat-icon>
                                <mat-error *ngIf="localiteForm.get('nom').hasError('required')">
                                    Ce champ est requise
                                </mat-error>
                            </mat-form-field>
                        </div>
                    </div>

                    <div class="modal-footer pr-0 pt-0">
                        <div class="button-demo">
                            <button type="submit" class="btn btn-outline-success btn-border-radius" [disabled]="localiteForm.invalid">Enregistrer</button>
                            <button type="button" class="btn btn-outline-danger btn-border-radius mr-0" data-dismiss="modal">Annuler</button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>
<!--Localités-->

<!--Zone-->
<div class="modal fade" id="zoneModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" data-keyboard="false">
    <div class="modal-dialog" role="document">
        <form class="modal-content"  [formGroup]="zoneForm" (ngSubmit)="addZone(zoneForm)" #formDirective2="ngForm">
            <div class="modal-header">
                <div class="editRowModal">
                    <div class="modal-header clearfix">
                        <div class="modal-about">
                            <div class="font-weight-bold p-t-10 font-17" *ngIf="zoneForm.get('id').value==0">Ajouter une zone</div>
                            <div class="font-weight-bold p-t-10 font-17" *ngIf="zoneForm.get('id').value!=0">Modifier une zone</div>
                        </div>
                    </div>
                </div>
                <button type="button" #closeZoneModal
                    class="btn p-t-10 modal-close-button" data-dismiss="modal"
                    aria-label="Close">
                    <i class="material-icons">clear</i>
                </button>
            </div>
            <div class="modal-body">
                <div>
                    <div class="row">
                        <div class="input-field col s12 d-none">
                            <input formControlName="id" class="form-control" type="hidden">
                        </div>
                        <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 pb-0">
                            <mat-form-field class="example-full-width" appearance="outline">
                                <mat-label>Nom de la zone</mat-label>
                                <input matInput formControlName="nom">
                                <mat-icon matSuffix>room</mat-icon>
                                <mat-error *ngIf="zoneForm.get('nom').hasError('required')">
                                    Ce champ est requise
                                </mat-error>
                            </mat-form-field>
                        </div>
                    </div>

                    <div class="modal-footer pr-0 pt-0">
                        <div class="button-demo">
                            <button type="submit" class="btn btn-outline-success btn-border-radius" [disabled]="zoneForm.invalid">Enregistrer</button>
                            <button type="button" class="btn btn-outline-danger btn-border-radius mr-0" data-dismiss="modal">Annuler</button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>
<!--Zone-->

<!--Sous-zone-->
<div class="modal fade" id="SousZoneModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" data-keyboard="false">
    <div class="modal-dialog" role="document">
        <form class="modal-content"  [formGroup]="souZoneForm" (ngSubmit)="updateSZ(souZoneForm)" #formDirective3="ngForm">
            <div class="modal-header">
                <div class="editRowModal">
                    <div class="modal-header clearfix">
                        <div class="modal-about">
                            <div class="font-weight-bold p-t-10 font-17">Modifier sous-zone</div>
                        </div>
                    </div>
                </div>
                <button type="button" #closeSousZoneModal
                    class="btn p-t-10 modal-close-button" data-dismiss="modal"
                    aria-label="Close">
                    <i class="material-icons">clear</i>
                </button>
            </div>
            <div class="modal-body">
                <div>
                    <div class="row">
                        <div class="input-field col s12 d-none">
                            <input formControlName="id" class="form-control" type="hidden">
                        </div>
                        <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 pb-0">
                            <mat-form-field class="example-full-width" appearance="outline">
                                <mat-label>Nom sous-zone</mat-label>
                                <input matInput formControlName="nom">
                                <mat-icon matSuffix>room</mat-icon>
                                <mat-error *ngIf="souZoneForm.get('nom').hasError('required')">
                                    Ce champ est requise
                                </mat-error>
                            </mat-form-field>
                        </div>
                    </div>

                    <div class="modal-footer pr-0 pt-0">
                        <div class="button-demo">
                            <button type="submit" class="btn btn-outline-success btn-border-radius" [disabled]="souZoneForm.invalid">Enregistrer</button>
                            <button type="button" class="btn btn-outline-danger btn-border-radius mr-0" data-dismiss="modal">Annuler</button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>
<!--Sous-zone-->
