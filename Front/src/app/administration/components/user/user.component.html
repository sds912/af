<section class="content" *ngIf="show">
    <div class="container-fluid">
        <div class="row clearfix">
            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                <div class="card">
                    <div class="body">
                        <div class="row">
                            <div class="col-sm-12">
                                <div class="ngxTableHeader">
                                    <ul class="header-buttons-left ml-0">
                                        <li class="dropdown">
                                            <h2>
                                                <strong>Utilisateurs</strong></h2>
                                        </li>
                                        <li class="dropdown m-l-20">
                                            <label for="search-input"><i class="material-icons search-icon">search</i></label>
                                            <input placeholder="Recherche" type="text" class="browser-default search-field" (keyup)='filterDatatable($event)' aria-label="Search box">
                                        </li>
                                    </ul>
                                    <ul class="header-buttons m-r-20">
                                        <li *ngIf="entreprises && entreprises.length>0">
                                            <div class="icon-button-demo">
                                                <button mat-mini-fab color="primary" data-toggle="modal" data-backdrop="static" data-keyboard="false"
                                                    data-target="#editModal" (click)='addRow()'>
                                                    <mat-icon class="col-white">add</mat-icon>
                                                </button>
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                                <ngx-datatable #table class="material" [rows]="data" [columns]="columns" [sortType]="'multi'" [columnMode]="'force'" [headerHeight]="50" [footerHeight]="50" [rowHeight]="'60'" [limit]="10">
                                    <!-- user image -->
                                    <ngx-datatable-column name="" sortable="false" prop="image" [width]="10">
                                        <ng-template let-row="data" let-value="value" let-i="index" ngx-datatable-cell-template>
                                            <td class="table-img padding-0">
                                                <img width="40" src="{{ imgLink + value }}" />
                                            </td>
                                        </ng-template>
                                    </ngx-datatable-column>
                                  
                                    <ngx-datatable-column name="Prénom et nom" sortable="false" prop="nom" [width]="130">
                                        <ng-template let-row="data" let-value="value" let-i="index" ngx-datatable-cell-template>
                                            <td class="table-img padding-0" [title]="value">
                                                {{longText(value,20)}}
                                            </td>
                                        </ng-template>
                                    </ngx-datatable-column>

                                    <ngx-datatable-column name="Département" sortable="false" prop="departement" [width]="130">
                                        <ng-template let-row="data" let-value="value" let-i="index" ngx-datatable-cell-template>
                                            <td class="table-img padding-0" [title]="value">
                                                {{longText(value,20)}}
                                            </td>
                                        </ng-template>
                                    </ngx-datatable-column>
                                    
                                    <ngx-datatable-column name="Rôle" sortable="false" prop="roles" [width]="80">
                                        <ng-template let-row="data" let-value="value" let-i="index" ngx-datatable-cell-template>
                                            <td class="table-img padding-0" [title]="getRole(value)">
                                                {{longText(getRole(value),15)}}
                                            </td>
                                        </ng-template>
                                    </ngx-datatable-column>
                                    <ngx-datatable-column name="Entité" sortable="false" prop="entreprises" [width]="130">
                                        <ng-template let-row="data" let-value="value" let-i="index" ngx-datatable-cell-template>
                                            <td class="table-img padding-0">
                                                <span *ngIf="value && value.length==1" [title]="value[0].denomination">{{longText(value[0].denomination,20)}}</span>
                                                <select *ngIf="value && value.length>1" class="form-control no-border pl-0" style="border: none !important;">
                                                   <option *ngFor="let e of value">{{e.denomination}}</option> 
                                                </select>
                                            </td>
                                        </ng-template>
                                    </ngx-datatable-column>
                                    
                                    <!-- action buttons -->
                                    <ngx-datatable-column name="Actions" sortable="false" [width]="130" class="text-center">
                                        <ng-template let-value="value" let-row="row" let-rowIndex="rowIndex"
                                            ngx-datatable-cell-template>
                                            <span>
                                                <button class="btn tblActnBtn pointer h-auto" data-toggle="modal" data-backdrop="static" data-keyboard="false" data-target="#editModal" title="Afficher les detais de l'utilisateur" (click)='showDetails(row)'>
                                                    <i class="material-icons">remove_red_eye</i>
                                                </button>
                                                <button class="btn tblActnBtn pointer h-auto" data-toggle="modal" data-backdrop="static" data-keyboard="false"
                                                    data-target="#editModal" title="Modifier l'utilisateur" (click)='updateUser(row)'>
                                                    <i class="material-icons">mode_edit</i>
                                                </button>
                                                <button class="btn tblActnBtn pointer h-auto" data-toggle="modal" data-backdrop="static" data-keyboard="false"
                                                    data-target="#editModal" title="Réinitialiser le mot de passe de l'utilisateur" (click)='backupPwd(row)'>
                                                    <i class="material-icons">refresh</i>
                                                </button>
                                                <button class="btn tblActnBtn pointer h-auto" [ngClass]="{'text-success': row.status=='actif','text-danger': row.status=='bloque'}" title="Bloquer/Débloquer un utilisateur" (click)='lockRow(row)'>
                                                    <i class="material-icons" *ngIf="row.status=='actif'">lock_open</i>
                                                    <i class="material-icons" *ngIf="row.status=='bloque'">lock_outline</i>
                                                </button>
                                            </span>
                                        </ng-template>
                                    </ngx-datatable-column>
                                </ngx-datatable>

                                <!-- Modal Window -->
                                <div class="modal fade" id="editModal" tabindex="-1" role="dialog"
                                    aria-labelledby="exampleModalLabel" aria-hidden="true">
                                    <div class="modal-dialog" role="document">
                                        <form class="modal-content"  [formGroup]="editForm" (ngSubmit)="onEditSave(editForm)">
                                            <div class="modal-header">
                                                <div class="editRowModal">
                                                    <div class="modal-header clearfix">
                                                        <img *ngIf="selectedRowData?.image" [src]='imgLink+selectedRowData?.image' alt="avatar">
                                                        <img *ngIf="!selectedRowData?.image" [src]='newUserImg' alt="avatar">
                                                        <div class="modal-about">
                                                            <div class="font-weight-bold p-t-10 font-17" *ngIf="!selectedRowData?.nom">Nouvel utilisateur</div>
                                                            <div class="font-weight-bold p-t-10 font-17" *ngIf="selectedRowData?.nom">{{selectedRowData?.nom}}</div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <button type="button" #closeEditModal
                                                    class="btn p-t-10 modal-close-button" data-dismiss="modal"
                                                    aria-label="Close">
                                                    <i class="material-icons">clear</i>
                                                </button>
                                            </div>
                                            <div class="modal-body">
                                                <div>
                                                    <div class="input-field col s12 d-none">
                                                        <input formControlName="id" class="form-control" type="hidden">
                                                        <input formControlName="status" class="form-control" type="hidden">
                                                    </div>
                                                    <div class="row pr-3">
                                                        <div class="col-xl-6 col-lg-6 col-md-12 col-sm-12 mb-2">
                                                            <mat-form-field class="example-full-width"
                                                                appearance="outline">
                                                                <mat-label>Prénom et nom</mat-label>
                                                                <input matInput formControlName="nom" required (change)="nomChange($event.target.value)">
                                                                <mat-icon matSuffix>face</mat-icon>
                                                                <mat-error
                                                                    *ngIf="editForm.get('nom').hasError('required')">
                                                                    Le nom complet est requise
                                                                </mat-error>
                                                            </mat-form-field>
                                                        </div>
                                                        <div class="col-xl-6 col-lg-6 col-md-12 col-sm-12 mb-2">
                                                            <mat-form-field class="example-full-width"
                                                                appearance="outline">
                                                                <mat-label>Poste</mat-label>
                                                                <input matInput formControlName="poste">
                                                                <mat-icon matSuffix>card_travel</mat-icon>
                                                            </mat-form-field>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 mb-2">
                                                            <mat-form-field class="example-full-width"
                                                                appearance="outline">
                                                                <mat-label>Login</mat-label>
                                                                <input matInput formControlName="username" required>
                                                                <mat-icon matSuffix>assignment_ind</mat-icon>
                                                                <mat-error *ngIf="editForm.get('nom').hasError('required')">
                                                                    Le login est requis
                                                                </mat-error>
                                                            </mat-form-field>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 mb-2">
                                                            <mat-form-field class="example-full-width" appearance="outline">
                                                                <mat-label>Département</mat-label>
                                                                <input matInput [value]="firstDep" disabled="true"  *ngIf="details">
                                                                <mat-select  name="depart" [value]="firstDep" (selectionChange)="depChange($event.value)" *ngIf="!details">
                                                                    <mat-option *ngFor="let d of dep" [value]="d">{{d}}</mat-option>
                                                                </mat-select>                                                               
                                                            </mat-form-field>
                                                        </div>
                                                    </div>
                                                    <div class="row" [hidden]="!autreDep">
                                                        <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 mb-2">
                                                            <mat-form-field class="example-full-width"
                                                                appearance="outline">
                                                                <mat-label>Autre département</mat-label>
                                                                 <input matInput formControlName="departement" required>
                                                                <mat-icon matSuffix>phone</mat-icon>
                                                            </mat-form-field>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 mb-2">
                                                            <mat-form-field class="example-full-width"
                                                                appearance="outline">
                                                                <mat-label>Rôle</mat-label>
                                                                <input matInput formControlName="departement" *ngIf="details">
                                                                <mat-select formControlName="role"  *ngIf="!details">
                                                                    <mat-option *ngFor="let r of roles" [value]="r">{{r}}</mat-option>
                                                                </mat-select>
                                                            </mat-form-field>
                                                        </div>
                                                    </div>
                                                    <div class="row" *ngFor="let control of tabEse.controls; index as i" [hidden]="entreprises && entreprises.length<2">
                                                        <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 mb-2 pr-0">
                                                            <mat-form-field class="example-full-width mr-2" appearance="outline" style="width: 92% !important;">
                                                                <mat-label>Entité</mat-label>
                                                                <mat-select [formControl]="control">
                                                                    <mat-option value="" *ngIf="i>0"></mat-option>
                                                                    <mat-option *ngFor="let e of entreprises" [value]="e.id">{{e.denomination}}</mat-option>
                                                                </mat-select>
                                                            </mat-form-field>
                                                             <mat-icon matSuffix [hidden]="i!=(tabEse.controls.length-1) || !control.value" (click)="addEntreprise()" class="pointer">add_circle_outline</mat-icon>
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer" [hidden]="details">
                                                        <div class="button-demo">
                                                            <button type="submit" class="btn btn-outline-success btn-border-radius">Enregistrer</button>
                                                            <button type="button" class="btn btn-outline-danger btn-border-radius" data-dismiss="modal">Annuler</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                                <!-- Modal Window -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>